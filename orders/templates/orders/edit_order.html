<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Order</title>
    <style>
        .form-row { margin-bottom: 10px; }
        .remove-button { margin-left: 10px; color: red; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <a href="{% url 'order_list' %}">Back</a>
    <h1>Edit Order</h1>
    <form method="post">
        {% csrf_token %}
        {{ order_form.as_p }}
        <div id="product-forms">
            {{ product_formset.management_form }}
            {% for form in product_formset %}
                <div class="form-row">
                    {{ form.id }}
                    <div class="form-row">
                        {{ form.name.errors }}
                        <p>{{ form.name.label }}: {{ form.name }}</p>
                        {{ form.description.errors }}
                        <p>{{ form.description.label }}: {{ form.description }}</p>
                        {{ form.price.errors }}
                        <p>{{ form.price.label }}: {{ form.price }} â‚¬</p>
                        {% if form.instance.pk %}
                            Delete {{ form.DELETE }}
                        {% endif %}
                    </div>
                    {% if forloop.last and not form.instance.pk %}
                        <span class="remove-button" onclick="removeProductForm(this)">Remove</span>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
        <button type="button" id="add-product">Add another product</button>
        <button type="submit">Save</button>
    </form>

    <script>
        document.getElementById('add-product').addEventListener('click', function () {
            addProductForm();
        });

        function addProductForm() {
            const formCount = document.getElementById('id_form-TOTAL_FORMS');
            const currentFormCount = parseInt(formCount.value);
            const newForm = document.createElement('div');
            newForm.classList.add('form-row');
            newForm.innerHTML = document.querySelector('.form-row').innerHTML.replace(/form-\d+-/g, `form-${currentFormCount}-`);

            // Add remove button to the new form
            const removeButton = document.createElement('span');
            removeButton.classList.add('remove-button');
            removeButton.innerText = 'Remove';
            removeButton.setAttribute('onclick', 'removeProductForm(this)');
            newForm.appendChild(removeButton);

            // Append the new form
            document.getElementById('product-forms').appendChild(newForm);
            formCount.value = currentFormCount + 1;
        }
    
        function removeProductForm(button) {
            const formRow = button.parentElement;
            const deleteCheckbox = formRow.querySelector('input[type="checkbox"]');

            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                formRow.classList.add('hidden');
            } else {
                formRow.remove();
                const formCount = document.getElementById('id_form-TOTAL_FORMS');
                formCount.value = parseInt(formCount.value) - 1;

                // Reassign indices
                const forms = document.querySelectorAll('.form-row');
                forms.forEach((form, index) => {
                    form.innerHTML = form.innerHTML.replace(/form-(\d+)-/g, `form-${index}-`);
                });
            }
        }
    </script>
</body>
</html>
